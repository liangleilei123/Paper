# Networks for Joint Afﬁne and Non-parametric Image Registration



配准对象

我们对骨关节炎倡议 (OAI) 数据集的膝关节 3D 磁共振图像 (MRI) 进行了纵向和跨对象实验。



图像配准
输入两幅图片，已知一副图像是另外一副图像变换得到，通过计算反推出变换。

常用的方法就是根据特征点，代入图像变换的公式求解。

特征点的最少数目，取决于变换的方式。而特征点越多，自然配准越容易，越准确。





该网络处理的是三维网络



非参数配准

非参数模型不遵循任何参数化，允许每个图像元素任意移位





梯度是函数在变量空间的某一点处，函数对x的偏导和函数对y的偏导相加。梯度总是指向函数值增长最大的方向。梯度是各个维度上偏导矢量的向量和，天然就是该点最大的变化率，方向也是该点最大的变化方向。



- 本模型是一种端到端的配准方法。

这个端到端的配准理解的时候应该分开理解，端到端（end to end）在深度学习中的理解是模型将所有分布解决的中间步骤连接整合到一起，成为一个黑盒子，我们能看看到的只是输入的数据和输出的结果，就是从数据的端，到了结果的端。

在训练过程中，从输入端（输入数据）到输出端得到一个预测结果，该结果与真实结果相比较会得到一个误差，这个误差将用于模型每一层的调整（比如反向传播），这种训练直到模型收敛或达到预期的效果才结束，这就是端到端（end-to-end）的。



第一部分：多步仿射网络

作用：预测仿射变换参数和相应的变换图。目标图像保持不变，通过DNN网络来预测仿射参数从而变换源图像。预测过程是一个多步的过程。

- 什么是仿射变换
  
  - 仿射变换，又称仿射映射，是指在几何中，一个向量空间进行一次线性变换并接上一个平移，变换为另一个向量空间。
  
    简单来说就是一个目标图像矩阵是通过源图像矩阵通过**一个线性变换（矩阵A）+一个平移（b）**变换得到的
  
    
  
- 预测参数用来干啥

  - 预配准过程中大的全局位移或旋转问题
  
- 为啥用仿射网络

  - 非参数配准方法通常从预先配准的图像对开始，最通常基于仿射配准，以解决大的全局位移或旋转问题
  
- 仿射网络的作用是啥

  - 由于后续网络的非参数配准方法通常从预先配准的图像对开始，最普遍的方法是用仿射配准来**解决大的全局位移或旋转问题**。因此，在框架的第一部分，使用多步仿射网络直接预测仿射配准参数和相应的变换图。
  
- 什么是多步仿射网络

​	是一个循环网络，他逐步细化预测的仿射网络

- DNN深度神经网络
  - DNN是全连接网络，
  - 神经网络的正向传播中，进行的矩阵的乘积运算，在几何学领域被称为“仿射变换”。几何中，仿射变换包括一次线性变换和一次平移，分别对应神经网络的加权和运算与加偏置运算。
  
- 网络架构
  - 图 2 显示了网络架构。为了避免由于连续三线性插值导致的数值不稳定性和数值耗散，我们直接更新仿射配准参数，而不是在中间步骤中重新采样图像。具体来说，在每一步中，我们将目标图像和扭曲的源图像（使用先前的仿射参数从源图像插值获得）作为输入，然后输出新的仿射参数以进行变换细化。

- 为什么是多步

  - 网络需要足够灵活以适应小型和大型仿射变形，在训练过程发现单个仿射网络在实践中表现不佳。多步仿射网络显著提高了准确性和稳定性。
  
- 多步是几步，t怎么确定

  - 训练时是三步，测试时是七步。
  
- 怎么预测参数

  - 先训练一个单步网络并使用他的参数初始化多步网络,再用DNN训练
  
- 损失函数
  - 图像相似性损失
    - 归一化互相关NCC：来描述两个同维向量，窗口或样本之间的相关性。其取值范围是-1~1，-1代表两向量不相关，1代表两向量相关
      - 标准 LNCC 是通过平均以采样体素为中心的重叠滑动窗口的 NCC 分数来计算的。令 V 为图像的体积； xi, yi 分别指扭曲的源和目标体积中的第 i 个 (i ∈ {1, .., |V|}) 体素。 Ns 是指立方大小为 s×s×s 的滑动窗口的数量。令 ζs j 指以第 j 个体素为中心的窗口，而¯xj, ¯yj 分别代表扭曲源图像和目标图像中 ζs j 上的平均图像强度值。具有窗口大小 s 的 LNCC，表示为 κs，定义为
    
    ![image-20221003173545102](E:\Paper\ReadNote\registration\联合仿射和非参数配准网络.assets\image-20221003173545102.png)
    
    令 ζs j 指以第 j 个体素为中心的窗口，而¯xj, ¯yj 分别代表扭曲源图像和目标图像中 ζs j 上的平均图像强度值。
    
    - 我们将 mk-LNCC 定义为具有不同窗口大小的 LNCC 的加权和。为了计算效率，可以在以 V 的体素子集为中心的窗口上评估 LNCC
    
  - 正则化损失
    - 正则化损失 La-reg(Γ) 惩罚组合仿射变换与恒等式的偏差
    
  - 对称性损失
    - 对称损失 La-sym(Γ, Γts) 鼓励配准是逆一致的。即，我们希望鼓励从源图像到目标图像计算的变换是从目标图像到源图像计算的变换的逆变换

$A_{(t)}={A}_{(t)} A_{(t-1)}, b_{(t)}={A}_{(t)} b_{(t-1)}+{b}_{(t)}, \\{ s.t. } \ \ \ A_{(0)}=I, b_{(0)}=0$





LDDMM通过配分同胚映射实现的大变形

优化问题：



第二部分：动量生成网络

使用类似unet的网络来生成动量，然后通过平滑计算速度场

- 我们实现了一个深度神经网络来生成向量动量。
  - 在训练期间，梯度首先通过平流方程的积分器反向传播，然后是动量生成网络。 这可能需要大量内存。 因此，为了减少内存需求，网络输出低分辨率动量。 在实践中，我们删除了 U-net 的最后一个解码器级别。 在这种情况下，剩余的 vSVF 组件也在低分辨率地图上运行。

- 作用：预测配准模型vSVF的动量



网络框架

- residual link 即将卷积输出与原图合并
- 激活函数
  - ReLU函数其实是分段线性函数，把所有的负值都变为0，而正值不变，这种操作被成为**单侧抑制**。
  - Leaky ReLU是给所有负值赋予一个非零斜率。
  - stride 步长为2
  - deconv反卷积







第三部分：vSVF配准

vSVF(vector momentum-parameterized stationary velocity field)矢量动量参数化的静止速度场



源图像空间中的变换图$\phi$是通过速度场v(x,t)的时间积分获得的。



重点是微分同胚变换



速度场：是由每一时刻、每一点上的速度矢量组成的物理场。

每一个离散坐标位置在某个时刻 t 都有一个速度 v(x,t).

离散图像是以一定网格为周期，把X，Y坐标轴划分为棋盘式的网格，仅取离散的各个交点位置上的灰度值，构成的图像称为离散图像，也称采样图像。

离散坐标就是各个交点的坐标。

大部分情形下，速度场的每个空间位置大小都不同，这里我们就只考虑时间关系，简化下表达就是随时间变化的话记作 v(t), 不随时间变化的话就是v(t)=v(0). 对于某个时间点 t (假定 t∈[0,1] ) 的图像， 我们标记为 I(t) . 所以 I(1)代表的就是最后的warped图像 （这里注意和target图像， I1 的区别).



作者提出的网络是先预测动量，再将动量平滑得到速度场。



采用基于自迭代映射的vSVF组件，根据转换映射的当前估计提供非参数细化。

作用：输出合成的变换图（网格图）和扭曲的源图像，作为最终的配准结果。



为了捕获大变形并保证微分变换，经常采用由流体力学驱动的配准算法。这里，源图像空间中的变换图 Φ 3是通过速度场v(x，t) 的时间积分获得的，需要对其进行估计。控制微分方程为: Φ t(x，t) = v(Φ(x，t)，t)，Φ(x，0) = Φ(0)(x)，其中 Φ(0) 是初始映射。对于足够平滑的速度场v，可以获得微分变换。通过惩罚v的非光滑度来实现足够的光滑度。



![image-20220928153241355](E:\Paper\ReadNote\registration\联合仿射和非参数配准网络.assets\image-20220928153241355.png)

对于足够平滑的速度场v（v*），可以获得微分变换。通过惩罚V的非光滑度来实现足够的光滑度。

$||v||_L^2$正则项用来规范速度场的行为。第二项是相似度





具体而言，将预测的动量和下采样的初始图输入到 vSVF 单元，其输出最终上采样以获得全分辨率变换图。在 vSVF 单元内部，通过对动量进行平滑获得速度场，然后用于求解平流方程，Φ−1 (τ)t + DΦ−1 (τ)v = 0，单位时间（使用几个离散时间点）。然后，这导致了所寻求的转换图。这里提到的初始图可以是仿射图，也可以是之前vSVF步骤得到的图





数据集

骨关节炎倡议 (OAI) 数据集包含来自 88 名患者的 176 张手动标记的磁共振 (MR) 图像（每位患者进行 2 次纵向扫描）和来自 2,444 名患者的 22,950 张未标记的 MR 图像。标签可用于股骨和胫骨软骨。所有图像的尺寸为 384 × 384 × 160，其中每个体素的尺寸为 0.36 × 0.36 × 0.7mm3。我们对每个图像的强度进行归一化，使第 0.1 个百分位和第 99.9 个百分位映射到 0、1，并钳制小于 0 和大于 1 的值以避免异常值。所有图像都被下采样到 192 × 192 × 80。

3维的数据集